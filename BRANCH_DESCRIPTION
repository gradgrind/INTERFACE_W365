This is a simplified version of the Go code.
